function doGet(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("sheet1"); // Győződj meg róla, hogy a fül neve pontosan ez!
    
    // 1. DÁTUMOK BEOLVASÁSA (A oszlop)
    // Csak azokat a sorokat vesszük, amik dátum formátumúak (pontot tartalmaznak)
    const allAValues = sheet.getRange("A1:A100").getDisplayValues().flat();
    const dates = allAValues.filter(val => val.trim() !== "" && val.includes("."));

    // 2. JELENTKEZŐK BEOLVASÁSA (C és D oszlop)
    const fullData = sheet.getDataRange().getDisplayValues();
    const attendees = [];
    
    for (let i = 0; i < fullData.length; i++) {
      let nev = fullData[i][2];     // C oszlop
      let idopont = fullData[i][3]; // D oszlop
      
      // Kiszűrjük a fejlécet és a technikai sorokat (pl. az A oszlop generált dátumait a C-D-ben)
      if (nev && idopont && nev.trim() !== "" && nev !== "Név" && !nev.includes("202")) {
        attendees.push({ nev: nev, idopont: idopont });
      }
    }

    const output = { dates: dates, attendees: attendees };
    return ContentService.createTextOutput(JSON.stringify(output))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({error: err.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("sheet1");
  const params = JSON.parse(e.postData.contents);

  if (params.action === "add") {
    // Mentés: A=üres, B=Időbélyeg, C=Név, D=Időpont
    sheet.appendRow(["", new Date(), params.nev, params.idopont]);
    return ContentService.createTextOutput("Sikeres").setMimeType(ContentService.MimeType.TEXT);
  }

  if (params.action === "delete") {
    const data = sheet.getDataRange().getDisplayValues();
    // Hátulról megyünk előre törléskor
    for (let i = data.length - 1; i >= 0; i--) {
      if (data[i][2].trim() === params.nev.trim() && data[i][3].trim() === params.idopont.trim()) {
        sheet.deleteRow(i + 1);
        return ContentService.createTextOutput("Törölve").setMimeType(ContentService.MimeType.TEXT);
      }
    }
  }
}
