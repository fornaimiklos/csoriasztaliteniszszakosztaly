<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Edz√©s Jelentkez√©s ‚Äì Cs√≥ri asztalitenisz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }

    body {
      background: #f0f2f5;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background: #ffffff;
      border-radius: 24px;
      padding: 24px 20px 32px;
      width: 100%;
      max-width: 360px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
    }

    h1 {
      font-size: 26px;
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    h1 span.icon {
      font-size: 26px;
    }

    h2 { font-size: 14px; margin: 0 0 20px; text-align: center; color: #555; }

    label {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
    }

    input, select, button {
      width: 100%;
      border-radius: 14px;
      border: 1px solid #d0d7de;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      background: #f9fafb;
    }

    input:focus, select:focus {
      border-color: #ff4b73;
      box-shadow: 0 0 0 2px rgba(255,75,115,0.2);
      background: #ffffff;
    }

    select {
      cursor: pointer;
    }

    button {
      margin-top: 10px;
      border: none;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }

    #submitBtn {
      background: linear-gradient(135deg,#ff4b73,#ff7b3d);
    }

    #deleteBtn {
      background: #6c757d;
    }

    button:hover {
      filter: brightness(1.05);
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .field {
      margin-bottom: 14px;
    }

    .message {
      margin-top: 10px;
      font-size: 13px;
      min-height: 18px;
    }

    .message.ok { color: #1a7f37; }
    .message.error { color: #d32f2f; }

    .registrations-title {
      margin-top: 20px;
      font-size: 16px;
      font-weight: 700;
      text-align: left;
      border-top: 1px solid #eee;
      padding-top: 14px;
    }

    .session-block {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #e0e4ea;
    }

    .session-date {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .session-note {
      font-size: 12px;
      color: #ff4b73;
      margin-bottom: 4px;
    }

    .no-registrations {
      font-size: 13px;
      color: #777;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><span class="icon">üèì</span>Edz√©s Jelentkez√©s</h1>
    <h2>(Tagoknak NEM kell regisztr√°lni)</h2>

    <div class="field">
      <label for="name">√çrd be a neved‚Ä¶</label>
      <input id="name" type="text" placeholder="Cs√≥ri Pingpongos" />
    </div>

    <div class="field">
      <label for="date">V√°lassz id≈ëpontot</label>
      <select id="date">
        <option value="">-- V√°lassz id≈ëpontot --</option>
      </select>
    </div>

    <button id="submitBtn">Jelentkezem</button>
    <button id="deleteBtn">Jelentkez√©sem t√∂rl√©se</button>

    <p id="infoMessage" class="message"></p>

    <div class="registrations-title">Jelentkez≈ëk edz√©snaponk√©nt</div>
    <div id="registrationsContainer"></div>
  </div>

  <script>
    // Webapp URL (Apps Script)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxjVDYFpH6PHvFpCNeFONm7HZ6JVF00JfHLeUhaeKD03aNcp2biESNjLn0yPLfD4bv4/exec";

    const nameInput = document.getElementById("name");
    const dateSelect = document.getElementById("date");
    const submitBtn = document.getElementById("submitBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const infoMessage = document.getElementById("infoMessage");
    const registrationsContainer = document.getElementById("registrationsContainer");

    let allSessions = [];          // {dateText, note, isMatchDay}
    let currentRegistrations = []; // [ [N√©v, Id≈ëpont], ... ]

    async function loadData() {
      infoMessage.textContent = "Adatok bet√∂lt√©se‚Ä¶";
      infoMessage.className = "message";

      try {
        const res = await fetch(SCRIPT_URL + "?action=getData");
        const data = await res.json();

        allSessions = (data.dates || [])
          .filter(row => row[0])
          .map(row => {
            const dateText = row[0];
            const note = row[1] || "";
            const isMatchDay = note.toLowerCase().includes("meccsnap");
            return { dateText, note, isMatchDay };
          });

        populateDateSelect();
        renderRegistrations(data.registrations || []);

        infoMessage.textContent = "";
      } catch (err) {
        console.error("Hiba getData k√∂zben:", err);
        infoMessage.textContent = "Hiba az adatok bet√∂lt√©sekor.";
        infoMessage.className = "message error";
      }
    }

    function populateDateSelect() {
      dateSelect.innerHTML = '<option value="">-- V√°lassz id≈ëpontot --</option>';

      const firstFive = allSessions.slice(0, 5);

      firstFive.forEach(session => {
        const option = document.createElement("option");
        option.value = session.dateText;

        let label = session.dateText;
        if (session.note && session.note.trim().length > 0) {
          label += " ‚Äì " + session.note;
        }

        if (session.isMatchDay) {
          option.dataset.meccsnap = "true";
        }

        option.textContent = label;
        dateSelect.appendChild(option);
      });
    }

    // csak a kiv√°lasztott naphoz list√°zzuk a jelentkez≈ëket
    function renderSelectedDateRegistrations() {
      registrationsContainer.innerHTML = "";

      const selectedDate = dateSelect.value;
      if (!selectedDate) {
        const p = document.createElement("p");
        p.className = "no-registrations";
        p.textContent = "V√°lassz edz√©snapot, hogy l√°sd a jelentkez≈ëket.";
        registrationsContainer.appendChild(p);
        return;
      }

      const registrationsForDate = currentRegistrations.filter(r => r[1] === selectedDate);

      const sessionDiv = document.createElement("div");
      sessionDiv.className = "session-block";

      const sessionTitle = document.createElement("div");
      sessionTitle.className = "session-date";
      sessionTitle.textContent = selectedDate;
      sessionDiv.appendChild(sessionTitle);

      const sessionRow = allSessions.find(s => s.dateText === selectedDate);
      if (sessionRow && sessionRow.note) {
        const noteDiv = document.createElement("div");
        noteDiv.className = "session-note";
        noteDiv.textContent = sessionRow.note;
        sessionDiv.appendChild(noteDiv);
      }

      if (registrationsForDate.length === 0) {
        const p = document.createElement("p");
        p.className = "no-registrations";
        p.textContent = "Erre az id≈ëpontra m√©g nincs jelentkez≈ë.";
        sessionDiv.appendChild(p);
      } else {
        const list = document.createElement("ul");
        list.style.paddingLeft = "18px";
        list.style.margin = "0";

        registrationsForDate.forEach(row => {
          const li = document.createElement("li");
          li.textContent = row[0];
          list.appendChild(li);
        });

        sessionDiv.appendChild(list);
      }

      registrationsContainer.appendChild(sessionDiv);
    }

    function renderRegistrations(registrations) {
      currentRegistrations = registrations || [];
      renderSelectedDateRegistrations();
    }

    async function handleSubmit() {
      infoMessage.textContent = "";
      infoMessage.className = "message";

      const name = nameInput.value.trim();
      const dateText = dateSelect.value;

      if (!name) {
        infoMessage.textContent = "√çrd be a neved!";
        infoMessage.className = "message error";
        return;
      }

      if (!dateText) {
        infoMessage.textContent = "V√°lassz egy edz√©snapot!";
        infoMessage.className = "message error";
        return;
      }

      const selectedSession = allSessions.find(s => s.dateText === dateText);

      // Meccsnap tilt√°s
      if (selectedSession && selectedSession.isMatchDay) {
        infoMessage.textContent =
          "V√°runk szeretettel szurkol√≥k√©nt, de meccsnap miatt nincs lehet≈ës√©g edz√©sre jelentkezni ezen a napon. üôÇ";
        infoMessage.className = "message error";
        return;
      }

      // Max 5 f≈ë / nap
      const countForDate = currentRegistrations.filter(r => r[1] === dateText).length;
      if (countForDate >= 5) {
        infoMessage.textContent =
          "Erre az edz√©snapra betelt a l√©tsz√°m (max. 5 f≈ë). K√©rlek v√°lassz m√°sik id≈ëpontot, vagy egyeztess az edz≈ëvel.";
        infoMessage.className = "message error";
        return;
      }

      submitBtn.disabled = true;

      try {
        const params = new URLSearchParams({
          action: "register",
          name,
          date: dateText
        });

        const res = await fetch(SCRIPT_URL + "?" + params.toString());
        const data = await res.json();

        if (data.success) {
          infoMessage.textContent = "Sikeres jelentkez√©s! üôÇ";
          infoMessage.className = "message ok";
          nameInput.value = "";
          renderRegistrations(data.registrations || []);
        } else {
          infoMessage.textContent = data.message || "Nem siker√ºlt a jelentkez√©s.";
          infoMessage.className = "message error";
        }
      } catch (err) {
        console.error("Hiba register k√∂zben:", err);
        infoMessage.textContent = "Hiba t√∂rt√©nt a jelentkez√©s k√∂zben.";
        infoMessage.className = "message error";
      } finally {
        submitBtn.disabled = false;
      }
    }

    async function handleDelete() {
      infoMessage.textContent = "";
      infoMessage.className = "message";

      const name = nameInput.value.trim();
      const dateText = dateSelect.value;

      if (!name) {
        infoMessage.textContent = "A t√∂rl√©shez is √≠rd be a neved.";
        infoMessage.className = "message error";
        return;
      }

      if (!dateText) {
        infoMessage.textContent = "A t√∂rl√©shez is v√°lassz egy edz√©snapot.";
        infoMessage.className = "message error";
        return;
      }

      deleteBtn.disabled = true;

      try {
        const params = new URLSearchParams({
          action: "unregister",
          name,
          date: dateText
        });

        const res = await fetch(SCRIPT_URL + "?" + params.toString());
        const data = await res.json();

        if (data.success) {
          infoMessage.textContent = "A jelentkez√©sed t√∂r√∂lve lett.";
          infoMessage.className = "message ok";
          renderRegistrations(data.registrations || []);
        } else {
          infoMessage.textContent = data.message || "Nem siker√ºlt a t√∂rl√©s.";
          infoMessage.className = "message error";
        }
      } catch (err) {
        console.error("Hiba unregister k√∂zben:", err);
        infoMessage.textContent = "Hiba t√∂rt√©nt a t√∂rl√©s k√∂zben.";
        infoMessage.className = "message error";
      } finally {
        deleteBtn.disabled = false;
      }
    }

    submitBtn.addEventListener("click", handleSubmit);
    deleteBtn.addEventListener("click", handleDelete);
    dateSelect.addEventListener("change", renderSelectedDateRegistrations);

    loadData();
  </script>
</body>
</html>
