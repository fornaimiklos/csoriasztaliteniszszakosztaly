/*******************************
 *  CSÓRI ASZTALITENISZ - WEBAPP
 *  Google Apps Script (Code.gs)
 *******************************/

// =====================================================
// 1) BEÁLLÍTÁSOK – CSAK EZT A 3 SORT ÁLLÍTOD
// =====================================================

// IDE ÍRD BE A SAJÁT GOOGLE SHEET ID-T (a /d/ és /edit között)
// PÉLDA: "1AbCDefGhIJKlMnOPqRstUVwxYZ1234567890"
const SHEET_ID = "IDE_ÍRD_BE_A_SAJÁT_SHEET_ID-T";

// Edzésnapok lap neve: nálad a képen "sheet1" volt
const TRAININGS_SHEET_NAME = "sheet1";

// Jelentkezések lap neve: nálad "Jelentkezők" volt
const SIGNUPS_SHEET_NAME = "Jelentkezők";

// =====================================================
// 2) SEGÉDFÜGGVÉNYEK
// =====================================================
function json_(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function normalize_(s) { return String(s || "").trim(); }

function isHeaderLike_(value) {
  const v = String(value || "").toLowerCase();
  return v.includes("dátum") || v.includes("datum") || v.includes("idő") || v.includes("ido");
}

function getOrCreateSignupsSheet_(ss) {
  let sh = ss.getSheetByName(SIGNUPS_SHEET_NAME);
  if (!sh) {
    sh = ss.insertSheet(SIGNUPS_SHEET_NAME);
    sh.appendRow(["Timestamp", "Név", "Edzésnap", "Megjegyzés"]);
  } else {
    if (sh.getLastRow() === 0) {
      sh.appendRow(["Timestamp", "Név", "Edzésnap", "Megjegyzés"]);
    }
  }
  return sh;
}

// =====================================================
// 3) WEBAPP BELÉPÉSI PONT
// =====================================================
function doGet(e) {
  try {
    const action = (e && e.parameter && e.parameter.action) ? e.parameter.action : "getData";

    if (action === "getData") return handleGetData_();
    if (action === "signup")  return handleSignup_(e);
    if (action === "delete")  return handleDelete_(e);

    return json_({ ok: false, error: "Ismeretlen művelet: " + action });
  } catch (err) {
    return json_({ ok: false, error: String(err && err.stack ? err.stack : err) });
  }
}

// =====================================================
// 4) API: getData
// =====================================================
function handleGetData_() {
  const ss = SpreadsheetApp.openById(SHEET_ID);

  const trainingsSheet = ss.getSheetByName(TRAININGS_SHEET_NAME);
  if (!trainingsSheet) {
    return json_({ ok: false, error: "Nincs '" + TRAININGS_SHEET_NAME + "' lap." });
  }

  const signupsSheet = getOrCreateSignupsSheet_(ss);

  // Edzésnapok (A+B)
  const trValues = trainingsSheet.getDataRange().getValues();
  const trainings = [];

  for (let i = 0; i < trValues.length; i++) {
    const a = trValues[i][0];
    const b = trValues[i][1];

    if (!a) continue;
    if (isHeaderLike_(a)) continue;

    trainings.push({
      dateText: normalize_(a),
      noteText: b ? normalize_(b) : ""
    });
  }

  // Jelentkezések
  const suValues = signupsSheet.getDataRange().getValues();
  const signups = [];

  for (let i = 1; i < suValues.length; i++) {
    const ts = suValues[i][0];
    const name = suValues[i][1];
    const dateText = suValues[i][2];
    const noteText = suValues[i][3];

    if (!name || !dateText) continue;

    signups.push({
      ts: ts ? String(ts) : "",
      name: normalize_(name),
      dateText: normalize_(dateText),
      noteText: noteText ? normalize_(noteText) : ""
    });
  }

  return json_({ ok: true, trainings, signups });
}

// =====================================================
// 5) API: signup
// =====================================================
function handleSignup_(e) {
  const name = normalize_(e.parameter.name);
  const dateText = normalize_(e.parameter.dateText);
  const noteText = normalize_(e.parameter.noteText);

  if (!name) return json_({ ok: false, error: "Nincs név." });
  if (!dateText) return json_({ ok: false, error: "Nincs kiválasztott időpont." });

  // Meccsnap tiltás backend oldalon is
  if (noteText.toLowerCase().includes("meccsnap")) {
    return json_({ ok: false, error: "Meccsnap miatt edzés nem, de a szurkolás lehetséges! :)" });
  }

  const ss = SpreadsheetApp.openById(SHEET_ID);
  const signupsSheet = getOrCreateSignupsSheet_(ss);

  // Duplikáció védelem
  const values = signupsSheet.getDataRange().getValues();
  for (let i = 1; i < values.length; i++) {
    const existingName = normalize_(values[i][1]).toLowerCase();
    const existingDate = normalize_(values[i][2]);
    if (existingName === name.toLowerCase() && existingDate === dateText) {
      return json_({ ok: false, error: "Már jelentkeztél erre az edzésnapra." });
    }
  }

  signupsSheet.appendRow([new Date(), name, dateText, noteText]);
  return json_({ ok: true });
}

// =====================================================
// 6) API: delete
// =====================================================
function handleDelete_(e) {
  const name = normalize_(e.parameter.name);
  const dateText = normalize_(e.parameter.dateText); // opcionális

  if (!name) return json_({ ok: false, error: "Add meg a nevet törléshez." });

  const ss = SpreadsheetApp.openById(SHEET_ID);
  const signupsSheet = getOrCreateSignupsSheet_(ss);

  const values = signupsSheet.getDataRange().getValues();
  let deleted = 0;

  for (let i = values.length - 1; i >= 1; i--) {
    const rowName = normalize_(values[i][1]);
    const rowDate = normalize_(values[i][2]);

    const nameMatch = rowName.toLowerCase() === name.toLowerCase();
    const dateMatch = !dateText || rowDate === dateText;

    if (nameMatch && dateMatch) {
      signupsSheet.deleteRow(i + 1);
      deleted++;
    }
  }

  if (deleted === 0) return json_({ ok: false, error: "Nincs ilyen jelentkezés." });
  return json_({ ok: true, deleted });
}
